# 変換結果・プロンプト・TSVファイルのoutputsフォルダへの保存機能追加

## 日付
2025年11月13日

## 概要
StreamlitアプリケーションでPDF変換結果、プロンプトスクリプト、生成されたTSVファイルを`outputs`フォルダ内の新しいセッションフォルダに自動保存する機能を追加しました。

## 変更内容

### 実装した機能

1. **セッション固有の出力フォルダ作成**
   - PDF変換時に`outputs`フォルダ内に新しいセッションフォルダを作成
   - フォルダ名の形式: `YYYYMMDD_HHMMSS_pdfname`
     - 例: `20251113_143022_sample.pdf` → `20251113_143022_sample`

2. **変換結果の保存**
   - 変換されたMarkdownファイル → `converted.md`
   - メタデータファイル → `meta.json`
   - 画像ディレクトリ（存在する場合） → `images/`

3. **カード生成時のファイル保存**
   - 生成されたTSVファイル → `anki_cards.tsv`
   - プロンプトスクリプト → `prompt_script.sh`（実行可能権限付き）

### 変更ファイル

- `src/streamlit_app.py`
  - `datetime`と`shutil`モジュールをインポート追加
  - セッション状態に`session_output_dir`を追加
  - PDF変換処理を修正してセッションフォルダに結果を保存
  - カード生成処理を修正してTSVとプロンプトスクリプトを保存

### 技術的な詳細

1. **一時ディレクトリの使用**
   - 変換処理は一時ディレクトリで実行
   - 完了後に結果をセッションフォルダにコピー
   - 一時ディレクトリは自動的に削除

2. **ファイルパスの管理**
   - セッション状態に`session_output_dir`を保存
   - 後続の処理でこのパスを使用してファイルを保存

3. **ユーザーへの通知**
   - 変換完了時にセッションフォルダのパスを表示
   - カード生成完了時にも保存先を表示

## 使用方法

1. Streamlitアプリを起動
2. PDFファイルをアップロード
3. 「Convert to Markdown」ボタンをクリック
   - `outputs/YYYYMMDD_HHMMSS_pdfname/`フォルダが作成されます
   - 変換結果がこのフォルダに保存されます
4. 「Generate Anki Cards」ボタンをクリック
   - TSVファイルとプロンプトスクリプトが同じフォルダに保存されます

## 出力フォルダの構造

```
outputs/
  YYYYMMDD_HHMMSS_pdfname/
    ├── converted.md          # 変換されたMarkdownファイル
    ├── meta.json             # メタデータ（PDF SHA256、変換情報など）
    ├── images/               # 抽出された画像（存在する場合）
    ├── anki_cards.tsv        # 生成されたAnkiカード（TSV形式）
    └── prompt_script.sh      # LLMプロンプトスクリプト（実行可能）
```

## 利点

1. **履歴管理**: 各変換セッションの結果が個別のフォルダに保存されるため、過去の変換結果を簡単に参照可能
2. **再現性**: プロンプトスクリプトが保存されるため、同じ設定で再生成可能
3. **整理**: `outputs`フォルダ内で時系列順に整理される
4. **バックアップ**: 重要な変換結果を失うリスクが低減

## 注意事項

- セッションごとに新しいフォルダが作成されるため、`outputs`フォルダのサイズが増加する可能性があります
- 不要なセッションフォルダは手動で削除できます
- `.gitignore`で`outputs/`が除外されている場合、これらのファイルはGitにコミットされません

