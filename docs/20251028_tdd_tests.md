# Test-Driven Development for PDF2Anki (Core Prompt/Parsing)

Date: 2025-10-28

## Goal

Adopt TDD for the new features (Llama prompt command and Basic/Cloze support) by extracting pure logic and covering it with tests.

## What We Did

- Created `src/anki_core.py` containing:
  - `build_output_instructions(note_type, num_cards)`
  - `build_prompt(note_type, num_cards, content_focus, markdown_content)`
  - `parse_cards_from_output(model_output, note_type)`
  - `build_llm_prompt_script(md_path, num_cards, note_type, content_focus)`
- Updated `src/streamlit_app.py` to use `anki_core` functions (minimal UI changes).
- Added tests:
  - `tests/test_anki_core.py`: prompt building (basic/cloze), parsing (basic/cloze)
  - `tests/test_pdf2anki_types.py`: TSV export for Basic and Cloze
  - `tests/test_marker_client.py`: conversion flow with mocked HTTP
- Added `pytest` to `requirements.txt` and ran the suite (`8 passed`).

## How to Run Tests

```bash
cd /home/masan/PDF2Anki
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
pytest -q
```

## Notes

- The UI remains unchanged in behavior; logic has been modularized for testability.
- Marker API calls are mocked to avoid external dependencies.
- Parsing assumes the exact output formats shown in prompts (Basic and Cloze).
